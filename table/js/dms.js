String.prototype.startWith=function(A){if(A==null||A==""||this.length==0||A.length>this.length){return false}if(this.substr(0,A.length)==A){return true}else{return false}return true};String.prototype.endWith=function(A){if(A==null||A==""||this.length==0||A.length>this.length){return false}if(this.substring(this.length-A.length)==A){return true}else{return false}return true};Date.prototype.format=function(A){var D={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours()%12==0?12:this.getHours()%12,"H+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),"S":this.getMilliseconds()};var C={"0":"/u65e5","1":"/u4e00","2":"/u4e8c","3":"/u4e09","4":"/u56db","5":"/u4e94","6":"/u516d"};if(/(y+)/.test(A)){A=A.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}if(/(E+)/.test(A)){A=A.replace(RegExp.$1,((RegExp.$1.length>1)?(RegExp.$1.length>2?"/u661f/u671f":"/u5468"):"")+C[this.getDay()+""])}for(var B in D){if(new RegExp("("+B+")").test(A)){A=A.replace(RegExp.$1,(RegExp.$1.length==1)?(D[B]):(("00"+D[B]).substr((""+D[B]).length)))}}return A};function resetForm(B,A){$(B).find("input, textarea,select").each(function(){var C=$(this);if(contains(C.attr("name"),A)){return }if(C.is("input[type='hidden']")){C.val("")}else{if(C.is("input[type='text']")){C.val("")}else{if(C.is("input[type='password']")){C.val("")}else{if(C.is("select")){C.val("")}else{if(C.is("input[type='radio']")){C.attr("checked",false)}else{if(C.is("input[type='radio']")){C.attr("checked",false)}}}}}}})}function contains(C,A){if(!A||A.length==0){return false}for(var B=0;B<A.length;B++){if(C==A[B]){return true}}return false}var GlobalJs=function(A){this.path=A};GlobalJs.prototype={init:function(){var A=this;$(document).ajaxError(function(E,D,B,C){if(C=="Unauthorized"){location.href=A.path}})}};var UpFile=function(C,B,E,A,D){this.server=C;this.pickId=B;this.params=E;this.winSuccess=A;this.success=D};UpFile.prototype={init:function(){var A=this;var B="<div id='uploaderWin-"+A.pickId+"' style='display:none;'><div class='upfile-title'><div class='upfile-name'>文件名</div><div class='upfile-size'>文件大小</div><div class='upfile-status'>状态</div></div><div class='upfile-progress'></div><div class='upfile'><div class='upfile-name'><i></i><span class='upfile-text'></span></div><div class='upfile-size'></div><div class='upfile-status'></div><div class='upfile-oper'><i class='icon iconfont icon-delete red fa-lg' style='cursor:pointer;'></i></div></div><input type='file' name='file' class='webuploader-element-invisible' multiple='multiple'></div>";$("body").append(B);var F,D;F=WebUploader.create({resize:false,server:A.server,duplicate:true});if(A.params!=undefined){F.options.formData=A.params}function E(){layer.open({type:1,title:"文件上传",offset:"40px",zIndex:1025,shadeClose:true,shade:false,area:["540px","260px"],content:$("#uploaderWin-"+A.pickId),btn:["确定"],yes:function(G){layer.close(G);A.winSuccess()},success:function(){F.upload()}})}$("#"+A.pickId).click(function(){$("#uploaderWin-"+A.pickId).find("input[type=file]").trigger("click")});var C=function(){$("#uploaderWin-"+A.pickId).find("input[type=file]").change(function(){var G=this.files[0];F.addFiles(G)})};F.on("fileQueued",function(J){var L=J.name;var K=J.size;var Q=J.ext;var I=$("#"+A.pickId).attr("vf");if(I!=undefined&&I!=""){var P=I.split(",");var M=false;for(var N=0;N<P.length;N++){if(P[N]==Q){M=true}}if(!M){layer.msg("请选择"+I+"文件上传");return false}}D=J;var O=function(S){var R=(S.toString()).indexOf(".");if(R==-1){return S}return S.toFixed(1)};$("div.upfile").find("span.upfile-text").html(L);var H="";if(K<1024*1024){H=O(K/1024)+"K"}else{if(K<(1024*1024*1024)){H=O(K/(1024*1024))+"M"}else{H=O(K/(1024*1024*1024))+"G"}}$("div.upfile").find(".upfile-size").html(H);var G="";if(Q=="ppt"||Q=="pptx"){G="icon iconfont icon-ppt fa-lg red"}else{if(Q=="doc"||Q=="docx"){G="icon iconfont icon-word fa-lg blue"}else{if(Q=="xls"||Q=="xlsx"){G="icon iconfont icon-xls fa-lg deep-green"}else{if(Q=="pdf"){G="icon iconfont icon-PDF fa-lg red"}else{if(Q=="zip"||Q=="war"||Q=="rar"||Q=="jar"||Q=="gzip"){G="icon iconfont icon-zip fa-lg red"}else{if(Q=="jpg"||Q=="jpeg"||Q=="png"||Q=="gif"||Q=="bmp"){G="icon iconfont icon-image fa-lg red"}else{G="icon iconfont icon-file fa-lg red"}}}}}}$("div.upfile").find(".upfile-name").find("i").removeClass().addClass(G);$("div.upfile").find("div.upfile-status").html("上传");E()});F.on("uploadProgress",function(H,G){$("#uploaderWin-"+A.pickId).find(".upfile-progress").css("width",G*100+"%")});F.on("uploadSuccess",function(H,G){$("div.upfile").find("div.upfile-status").html("已上传");$("#uploaderWin-"+A.pickId).find(".upfile-oper").find("i").hide();A.success(H,G)});F.on("uploadError",function(G){$("#uploaderWin-"+A.pickId).find(".upfile-oper").find("i").hide();$("div.upfile").find("div.upfile-status").html("<span style='color:red'>上传出错</span>")});F.on("uploadComplete",function(G){$("#uploaderWin-"+A.pickId).find("input[type=file]").remove();$("#uploaderWin-"+A.pickId).append("<input type='file' name='file' class='webuploader-element-invisible' multiple='multiple'>");C()});$("#uploaderWin-"+A.pickId).find(".upfile-oper").find("i").click(function(){if(D!=null){F.cancelFile(D);$("div.upfile").find("div.upfile-status").html("已删除")}});C()}};var FileUploader=function(C,B,D,E,A){this.input=C;this.idx=B;this.type=D;this.PATH=E;this.nowUpload=A};FileUploader.prototype={init:function(fileNamex,fileDescx){var wu=this;var html='<div class="uploader"><div class="queueList"> <div class="placeholder">     <div id="filePicker-'+this.idx+'" class="filePicker"></div> </div></div><div class="statusBar" style="display:none;">  <div class="progress">      <span class="text">0%</span>       <span class="percentage"></span>  </div><div class="info"></div>   <div class="btns">       <div id="filePicker2-'+this.idx+'" class="filePicker2"></div><div class="uploadBtn">开始上传</div>   </div></div></div>';var $wrap=$(html);$wrap.insertAfter(wu.input);this.$wrap=$wrap;var $queue=$('<ul class="filelist"></ul>').appendTo($wrap.find(".queueList")),$statusBar=$wrap.find(".statusBar"),$info=$statusBar.find(".info"),$upload=$wrap.find(".uploadBtn"),$placeHolder=$wrap.find(".placeholder"),$progress=$statusBar.find(".progress").hide(),fileCount=0,fileSize=0,canFileCount=0,ratio=window.devicePixelRatio||1,thumbnailWidth=110*ratio,thumbnailHeight=110*ratio,state="pedding",percentages={},fileDesc=fileDescx!=undefined?fileDescx:{},fileName=fileNamex!=undefined?fileNamex:{},uploader;if(wu.nowUpload){$upload.hide()}uploader=WebUploader.create({pick:{id:"#filePicker-"+wu.idx,label:(wu.type=="file"?"点击选择文件":"点击选择图片")},chunked:false,chunkSize:512*1024,server:wu.PATH+"/form/upload.htm",disableGlobalDnd:true,fileNumLimit:300,});uploader.on("dndAccept",function(items){var denied=false,len=items.length,i=0,unAllowed="text/plain;application/javascript ";for(;i<len;i++){if(~unAllowed.indexOf(items[i].type)){denied=true;break}}return !denied});uploader.addButton({id:"#filePicker2-"+wu.idx,label:"继续添加"});uploader.on("ready",function(){window.uploader=uploader});function addFile(file){var $li=$('<li id="'+file.id+'" title="'+file.name+'"><p class="title">'+file.name+'</p><p class="imgWrap"><i class="icon iconfont icon-file" style="font-size:32px;"></i></p><p class="progress"><span></span></p></li>'),$btns=$('<div class="file-panel"><span class="cancel">删除</span></div>').appendTo($li),$prgress=$li.find("p.progress span"),$wrap=$li.find("p.imgWrap"),$info=$('<p class="error"></p>'),showError=function(code){switch(code){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试";break}$info.text(text).appendTo($li)};$prgress.parent().hide();if(file.getStatus()==="invalid"){showError(file.statusText)}else{if(wu.type=="img"){uploader.makeThumb(file,function(error,src){var img;if(error){$wrap.text("不能预览");return }img=$('<img src="'+src+'">');$wrap.empty().append(img)},thumbnailWidth,thumbnailHeight)}percentages[file.id]=[file.size,0];file.rotation=0}file.on("statuschange",function(cur,prev){if(prev==="progress"){$prgress.hide().width(0)}if(cur==="error"||cur==="invalid"){console.log(file.statusText);showError(file.statusText);percentages[file.id][1]=1}else{if(cur==="interrupt"){showError("interrupt")}else{if(cur==="queued"){percentages[file.id][1]=0}else{if(cur==="progress"){$info.remove();$prgress.parent().show();$prgress.css("display","block")}else{if(cur==="complete"){$li.append('<span class="success"></span>');$prgress.parent().hide()}}}}}$li.removeClass("state-"+prev).addClass("state-"+cur)});$li.on("mouseenter",function(){$btns.stop().animate({height:30})});$li.on("mouseleave",function(){$btns.stop().animate({height:0})});$btns.on("click","span",function(){var index=$(this).index(),deg;switch(index){case 0:uploader.removeFile(file);canFileCount--;return }});$li.appendTo($queue);canFileCount++}function addFileDesc(file){var $li=$('<li id="'+file.id+'" title="'+file.name+'"><p class="title">'+file.name+'</p><p class="imgWrap"><i class="icon iconfont icon-file" style="font-size:32px;"></i></p><p class="progress"><span></span></p></li>'),$btns=$('<div class="file-panel"><span class="cancel">删除</span></div>').appendTo($li),$prgress=$li.find("p.progress span"),$wrap=$li.find("p.imgWrap"),$info=$('<p class="error"></p>');$prgress.parent().hide();$li.on("mouseenter",function(){$btns.stop().animate({height:30})});$li.on("mouseleave",function(){$btns.stop().animate({height:0})});$btns.on("click","span",function(){var index=$(this).index(),deg;switch(index){case 0:removeFile(file);return }});$li.appendTo($queue);$li.append('<span class="success"></span>');setState("ready");$statusBar.show();fileCount++}function addImageDesc(file){var $li=$('<li id="'+file.id+'" title="'+file.name+'"><p class="title">'+file.name+'</p><p class="imgWrap"></p><p class="progress"><span></span></p></li>'),$btns=$('<div class="file-panel"><span class="cancel">删除</span></div>').appendTo($li),$prgress=$li.find("p.progress span"),$wrap=$li.find("p.imgWrap"),$info=$('<p class="error"></p>');$prgress.parent().hide();var imgSrc=wu.PATH+"/"+file.src;var img=$('<img src="'+imgSrc+'">');$wrap.empty().append(img);$li.on("mouseenter",function(){$btns.stop().animate({height:30})});$li.on("mouseleave",function(){$btns.stop().animate({height:0})});$btns.on("click","span",function(){var index=$(this).index(),deg;switch(index){case 0:removeFile(file);return }});$li.appendTo($queue);$li.append('<span class="success"></span>');setState("ready");$statusBar.show();fileCount++}function removeFile(file){var $li=$("#"+file.id);delete percentages[file.id];updateTotalProgress();$li.off().find(".file-panel").off().end().remove();var filePath=fileDesc[file.id];delete fileDesc[file.id];delete fileName[file.id];if(filePath){$.ajax({type:"POST",url:wu.PATH+"/form/del_file.htm",data:{imgPath:filePath},dataType:"json",success:function(suc){},error:function(){layer.alert("文件删除失败!",{icon:0})}})}fileCount--;if(!fileCount){setState("pedding")}if(wu.type=="img"){updateImageInput()}else{updateFileInput()}}function updateFileInput(){var paths="";for(var fd in fileDesc){paths+=fileName[fd];paths+=":";paths+=fileDesc[fd];paths+=","}wu.input.val(paths)}function updateImageInput(){var paths="";for(var fd in fileDesc){paths+=fileDesc[fd];paths+=","}wu.input.val(paths)}function updateTotalProgress(){var loaded=0,total=0,spans=$progress.children(),percent;$.each(percentages,function(k,v){total+=v[0];loaded+=v[0]*v[1]});percent=total?loaded/total:0;spans.eq(0).text(Math.round(percent*100)+"%");spans.eq(1).css("width",Math.round(percent*100)+"%");updateStatus()}function updateStatus(){var text="",stats;if(state==="ready"){text="选中"+fileCount+"个文件，共"+WebUploader.formatSize(fileSize)+"。"}else{if(state==="confirm"){stats=uploader.getStats();if(stats.uploadFailNum){text="已成功上传"+stats.successNum+"文件，"+stats.uploadFailNum+'文件上传失败，<a class="retry" href="#">重新上传</a>失败文件'}}else{stats=uploader.getStats();text="共"+fileCount+"个（"+WebUploader.formatSize(fileSize)+"），已上传"+stats.successNum+"个文件";if(stats.uploadFailNum){text+="，失败"+stats.uploadFailNum+"张"}}}$info.html(text)}function setState(val){var file,stats;if(val===state){return }$upload.removeClass("state-"+state);$upload.addClass("state-"+val);state=val;switch(state){case"pedding":$placeHolder.removeClass("element-invisible");$queue.hide();$statusBar.addClass("element-invisible");uploader.refresh();break;case"ready":$placeHolder.addClass("element-invisible");$("#filePicker2-"+wu.idx).removeClass("element-invisible");$queue.show();$statusBar.removeClass("element-invisible");uploader.refresh();break;case"uploading":$("#filePicker2-"+wu.idx).addClass("element-invisible");$progress.show();$upload.text("暂停上传");break;case"paused":$progress.show();$upload.text("继续上传");break;case"confirm":$progress.hide();$upload.text("开始上传").addClass("disabled");stats=uploader.getStats();if(stats.successNum&&!stats.uploadFailNum){setState("finish");return }break;case"finish":stats=uploader.getStats();if(stats.successNum){$upload.removeClass("disabled");$("#filePicker2-"+wu.idx).removeClass("element-invisible");if(wu.type=="img"){updateImageInput()}else{updateFileInput()}}else{state="done"}break}updateStatus()}uploader.onUploadProgress=function(file,percentage){var $li=$("#"+file.id),$percent=$li.find(".progress span");$percent.css("width",percentage*100+"%");percentages[file.id][1]=percentage;updateTotalProgress()};uploader.onFileQueued=function(file){fileCount++;fileSize+=file.size;if(fileCount===1){$placeHolder.addClass("element-invisible");$statusBar.show()}addFile(file);setState("ready");updateTotalProgress();if(wu.nowUpload){$upload.trigger("click")}};uploader.on("uploadSuccess",function(file,response){var json=eval("("+response._raw+")");fileDesc[file.id]=json.value[0];fileName[file.id]=file.name});uploader.onFileDequeued=function(file){fileSize-=file.size;removeFile(file);updateTotalProgress()};uploader.on("all",function(type){var stats;switch(type){case"uploadFinished":setState("confirm");break;case"startUpload":setState("uploading");break;case"stopUpload":setState("paused");break}});uploader.onError=function(code){if(code=="F_DUPLICATE"){layer.msg("该文件已存在")}};$upload.on("click",function(){if($(this).hasClass("disabled")||canFileCount<=0){return false}if(state==="ready"){uploader.upload()}else{if(state==="paused"){uploader.upload()}else{if(state==="uploading"){uploader.stop()}}}});$info.on("click",".retry",function(){uploader.retry()});$info.on("click",".ignore",function(){});$upload.addClass("state-"+state);updateTotalProgress();if(wu.type=="img"){if(!$.isEmptyObject(fileDesc)){for(var key in fileDesc){var file={};file.id=key;file.name=fileName[key];file.src=fileDesc[key];addImageDesc(file)}}}else{if(!$.isEmptyObject(fileName)){for(var key in fileName){var file={};file.id=key;file.name=fileName[key];addFileDesc(file)}}}}};var TreeObj=function(A){this.idx=A;$(document).click(function(){$("input.input-tree").each(function(){var B=$(this).data("o");if(B){B.hidden()}})})};TreeObj.prototype={init:function(inputObj){this.inputObj=inputObj;var divId="rpt-tree"+this.idx;var _div=$("<div></div>").addClass("layui-laydate");var contentHtml="<div class='ztree' id='"+divId+"' style='overflow:auto;padding:5px;'></div>";var footerHtml='<div class="layui-laydate-footer"><div class="laydate-footer-btns"><span class="laydate-btns-clear">清空</span><span class="laydate-btns-confirm">确定</span></div></div>';_div.append(contentHtml).append(footerHtml).hide().appendTo($("body"));var setting={view:{dblClickExpand:false},data:{simpleData:{enable:true}}};var data=inputObj.attr("data");if(!data){return }var curSetting=setting;var multi=inputObj.attr("multi");if(multi=="1"){curSetting={check:{enable:true,chkboxType:{"Y":"s","N":"s"}},data:{simpleData:{enable:true}}}}var thisVal=inputObj.next().val();var json=eval(""+data);$.fn.zTree.init($("#"+divId),curSetting,json);this.treeObj=$.fn.zTree.getZTreeObj(divId);this.divObj=_div;this.divObj.click(function(e){e.stopPropagation()});inputObj.data("o",this);_div.data("o",this);inputObj.next().next().click(function(e){$(this).prev().prev().trigger("click");e.stopPropagation()});inputObj.click(function(e){var treeO=$(this).data("o");var offset=$(this).offset();var height=$(document).height();var divTop=offset.top+$(this).height()+2;if(height-divTop<260){divTop=divTop-(260-(height-divTop))}treeO.divObj.show().css("left",offset.left).css("top",divTop);treeO.divObj.find("div.ztree").width($(this).width()+100).height(230);var ztree=treeO.treeObj;var thisVal=$(this).next().val();if(thisVal!=""){var splits=thisVal.split(",");var multi=$(this).attr("multi");for(var i=0;i<splits.length;i++){var node=ztree.getNodeByParam("queryCode",splits[i],null);if(node){if(multi=="1"){ztree.checkNode(node,true,false)}else{ztree.selectNode(node)}if(node.getParentNode()!=null){ztree.expandNode(node.getParentNode(),true,false,false)}}}}else{ztree.expandAll(false);ztree.checkAllNodes(false);ztree.refresh()}e.stopPropagation()});_div.find("span.laydate-btns-confirm").click(function(){var divO=$(this).parent().parent().parent();var treeO=divO.data("o");var inputObj=treeO.inputObj;var ztree=treeO.treeObj;var multi=inputObj.attr("multi");var nodes=multi=="1"?ztree.getCheckedNodes(true):ztree.getSelectedNodes();var name="";var queryCode="";for(var i=0;i<nodes.length;i++){name+=nodes[i].name;queryCode+=nodes[i].queryCode;if(i<nodes.length-1){name+=",";queryCode+=","}inputObj.val(name);inputObj.next().val(queryCode);inputObj.trigger("change")}treeO.hidden()});_div.find("span.laydate-btns-clear").click(function(){var divO=$(this).parent().parent().parent();var treeO=divO.data("o");treeO.hidden();treeO.inputObj.val("");treeO.inputObj.next().val("")})}};TreeObj.prototype.hidden=function(){this.divObj.hide()}